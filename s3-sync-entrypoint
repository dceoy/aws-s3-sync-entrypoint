#!/usr/bin/env bash
#
# Bash entrypoint to synchronize data with AWS S3 before and after command execution
#
# Usage:
#   s3-sync-entrypoint [--debug] [--dryrun] [--cp] (--s3-input=<uri>)...
#       [--s3-output=<uri>] (--inbound-sync-option=<arg>)...
#       (--outboud-sync-option=<arg>)... [--input-data-dir=<path>]
#       [--output-data-dir=<path>] <command>...
#   s3-sync-entrypoint --version
#   s3-sync-entrypoint -h|--help
#
# Options:
#   --debug             Run with debug mode
#   --dryrun            Print commands without execution
#   --cp                Use `aws s3 cp` instead of `aws s3 sync`
#   --s3-input=<uri>    Specify S3 input URIs
#                       (Data is transferred from S3 to `${INPUT_DATA_DIR}`.)
#   --s3-output=<uri>   Specify S3 output URIs
#                       (Data is transferred from `${OUTPUT_DATA_DIR}` to S3.)
#   --inbound-sync-option=<arg>
#                       Specify an option of `aws s3 sync` for inbound sync
#                       (e.g., --inbound-sync-option='--exclude="*.zip"')
#   --outbound-sync-option=<arg>
#                       Specify an option of `aws s3 sync` for outbound sync
#   --input-data-dir=<path>
#                       Specify a local directory path for input data from S3
#                       (This overrides `${INPUT_DATA_DIR}`.)
#   --output-data-dir=<path>
#                       Specify a local directory path for output data to S3
#                       (This overrides `${OUTPUT_DATA_DIR}`.)
#   --version           Print the version and exit
#   -h, --help          Print the usage and exit
#
# Arguments:
#   <command>           A command and arguments for it


set -euo pipefail

if [[ ${#} -ge 1 ]]; then
  for a in "${@}"; do
    [[ "${a}" = '--debug' ]] && set -x && break
  done
fi

SCRIPT_PATH=$(realpath "${0}")
SCRIPT_NAME=$(basename "${SCRIPT_PATH}")
SCRIPT_VERSION='v0.0.3'

DRYRUN=0
SYNC_COMMAND='sync'
S3_INPUT_URIS=()
S3_OUTPUT_URI=''
INBOUND_SYNC_OPTIONS=()
OUTBOUND_SYNC_OPTIONS=()
COMMAND=()
START_DATE="$(date +%s)"

function print_version {
  echo "${SCRIPT_NAME}: ${SCRIPT_VERSION}"
}

function print_usage {
  sed -ne '1,2d; /^#/!q; s/^#$/# /; s/^# //p;' "${SCRIPT_PATH}"
}

function abort {
  {
    if [[ ${#} -eq 0 ]]; then
      cat -
    else
      SCRIPT_NAME=$(basename "${SCRIPT_PATH}")
      echo "${SCRIPT_NAME}: ${*}"
    fi
  } >&2
  exit 1
}

function validate_s3_uri {
  for s in "${@}"; do
    [[ "${s}" =~ ^s3://.+ ]] || abort "invalid URI: ${s}"
  done
}

function echo_n_eval {
  printf "[%s]  $ %s\n" "$(date)" "${*}"
  if [[ ${DRYRUN} -eq 0 ]]; then
    eval "${@}"
  fi
}

while [[ ${#} -ge 1 ]]; do
  case "${1}" in
    '--debug' )
      shift 1
      ;;
    '--dryrun' )
      DRYRUN=1 && shift 1
      ;;
    '--cp' )
      SYNC_COMMAND='cp' && shift 1
      ;;
    '--s3-input' )
      S3_INPUT_URIS+=("${2}") && shift 2
      ;;
    --s3-input=* )
      S3_INPUT_URIS+=("${1#*\=}") && shift 1
      ;;
    '--s3-output' )
      S3_OUTPUT_URI="${2}" && shift 2
      ;;
    --s3-output=* )
      S3_OUTPUT_URI="${1#*\=}" && shift 1
      ;;
    '--inbound-sync-option' )
      INBOUND_SYNC_OPTIONS+=("${2}") && shift 2
      ;;
    --inbound-sync-option=* )
      INBOUND_SYNC_OPTIONS+=("${1#*\=}") && shift 1
      ;;
    '--outbound-sync-option' )
      OUTBOUND_SYNC_OPTIONS+=("${2}") && shift 2
      ;;
    --outbound-sync-option=* )
      OUTBOUND_SYNC_OPTIONS+=("${1#*\=}") && shift 1
      ;;
    '--input-data-dir' )
      INPUT_DATA_DIR="${2}" && shift 2
      ;;
    --input-data-dir=* )
      INPUT_DATA_DIR="${1#*\=}" && shift 1
      ;;
    '--output-data-dir' )
      OUTPUT_DATA_DIR="${2}" && shift 2
      ;;
    --output-data-dir=* )
      OUTPUT_DATA_DIR="${1#*\=}" && shift 1
      ;;
    '--version' )
      print_version && exit 0
      ;;
    '-h' | '--help' )
      print_usage && exit 0
      ;;
    -* )
      abort "invalid option: ${1}"
      ;;
    * )
      COMMAND=("${@:1}") && break
      ;;
  esac
done

printf "OSTYPE:                   %s\n" "${OSTYPE}"
printf "BASH:                     %s\n" "$(command -v bash)"
printf "S3_SYNC_ENTRYPOINT:       %s\n" "${SCRIPT_PATH}"
printf "AWSCLI:                   %s\n" "$(command -v aws)"
printf "PWD:                      %s\n" "${PWD}"

if [[ ${#S3_INPUT_URIS[@]} -gt 0 ]]; then
  printf "INPUT_DATA_DIR:           %s\n" "${INPUT_DATA_DIR}"
  printf "S3_INPUT_URIS:            %s\n" "${S3_INPUT_URIS[*]}"
  if [[ ${#INBOUND_SYNC_OPTIONS[@]} -gt 0 ]]; then
    INBOUND_SYNC="${SYNC_COMMAND} ${INBOUND_SYNC_OPTIONS[*]}"
  else
    INBOUND_SYNC="${SYNC_COMMAND}"
  fi
  printf "INBOUND_SYNC:             %s\n" "${INBOUND_SYNC}"
  validate_s3_uri "${S3_INPUT_URIS[@]}"
fi

if [[ "${S3_OUTPUT_URI}" != '' ]]; then
  printf "OUTPUT_DATA_DIR:          %s\n" "${OUTPUT_DATA_DIR}"
  printf "S3_OUTPUT_URI:            %s\n" "${S3_OUTPUT_URI}"
  if [[ ${#OUTBOUND_SYNC_OPTIONS[@]} -gt 0 ]]; then
    OUTBOUND_SYNC="${SYNC_COMMAND} ${OUTBOUND_SYNC_OPTIONS[*]}"
  else
    OUTBOUND_SYNC="${SYNC_COMMAND}"
  fi
  printf "OUTBOUND_SYNC:            %s\n" "${OUTBOUND_SYNC}"
  validate_s3_uri "${S3_OUTPUT_URI}"
fi

if [[ ${#COMMAND[@]} -gt 0 ]]; then
  printf "COMMAND:                  %s\n" "${COMMAND[*]}"
else
  abort "$(print_usage)"
fi


echo
echo_n_eval 'aws --version'

[[ -d "${INPUT_DATA_DIR}" ]] || echo_n_eval "mkdir -p ${INPUT_DATA_DIR}"
[[ -d "${OUTPUT_DATA_DIR}" ]] || echo_n_eval "mkdir -p ${OUTPUT_DATA_DIR}"

if [[ ${#S3_INPUT_URIS[@]} -gt 0 ]]; then
  for i in "${S3_INPUT_URIS[@]}"; do
    echo_n_eval "aws s3 ${INBOUND_SYNC} ${i} ${INPUT_DATA_DIR}"
  done
fi

echo_n_eval "${COMMAND[@]}"

if [[ "${S3_OUTPUT_URI}" != '' ]]; then
  echo_n_eval "aws s3 ${OUTBOUND_SYNC} ${OUTPUT_DATA_DIR} ${S3_OUTPUT_URI}"
fi

echo
ELAPSED_SECONDS=$(( $(date +%s) - START_DATE ))
printf "TOTAL_ELAPSED_TIME:       %s\n" "$(date --date=@${ELAPSED_SECONDS} -u +%H:%M:%S)"
